<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Daniel’s Media Explorer</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{--bg:#0f1223;--bg2:#171a2f;--text:#e9ecf5;--muted:#a7b0c0;--brand:#6ea8fe;--brand2:#a07bff;--card:#12162a;--card2:#151a33;--accent:#2a2f56}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;color:var(--text);
    background:radial-gradient(60rem 60rem at -20% -20%,#222a56 0,transparent 60%),radial-gradient(40rem 40rem at 120% -10%,#3b2d5e 0,transparent 60%),linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,#0e1225cc,#111633aa);backdrop-filter:blur(8px);border-bottom:1px solid #262b52}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 10px 28px #6ea8fe44,inset 0 0 10px #ffffff22}
  h1{margin:0;font-size:1.15rem}
  .sub{color:var(--muted);font-size:.9rem}
  .controls{display:grid;gap:10px;grid-template-columns:1fr auto auto auto auto auto}
  @media (max-width:840px){.controls{grid-template-columns:1fr 1fr 1fr}.controls>button{grid-column:1/-1}}
  input,select,button{height:40px;border-radius:10px;border:1px solid #2a2f56;background:#0e1330;color:var(--text);padding:0 12px}
  button{background:linear-gradient(135deg,var(--brand),var(--brand2));border:none;font-weight:600;cursor:pointer;box-shadow:0 6px 18px #6ea8fe35}
  button.secondary{background:#1a2044;border:1px solid #2a2f56;box-shadow:none}
  main{padding:18px 0 40px}
  .hint{text-align:center;color:var(--muted);padding:12px}
  .masonry{column-width:320px;column-gap:14px;max-width:1140px;margin:0 auto}
  @media (max-width:640px){.masonry{column-width:100%}}
  .card{display:inline-block;width:100%;margin:0 0 14px;background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);border:1px solid #24284a;border-radius:14px;overflow:hidden;box-shadow:0 10px 30px #0b0f2f66}
  .media{display:block;width:100%;background:#0b0f24}
  .body{padding:12px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .title{font-size:.9rem;color:var(--muted);white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .badge{font-size:.72rem;padding:6px 8px;border-radius:999px;border:1px solid #2b3160;background:#151a39;color:#b9c2da}
  .actions{display:flex;gap:8px;margin-top:12px}
  .chip{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:10px;padding:10px;background:#1a2044;border:1px solid #2a2f56;cursor:pointer}
  .chip.like.active{border-color:#bf2642;background:#2a1520}
  .count{font-variant-numeric:tabular-nums;opacity:.9}
  footer{border-top:1px solid #262b52;color:#9aa4be;padding:16px 0;text-align:center}
  .empty{max-width:760px;margin:32px auto;padding:24px;text-align:center;color:var(--muted);border:1px dashed #2a2f56;border-radius:12px;background:#101433}
  nav{display:flex;gap:8px;align-items:center}
  a.link{color:#c7d2fe;text-decoration:none}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Daniel’s Media Explorer</h1>
          <div class="sub">Your own media API — results stored in Gun, served from your API.</div>
        </div>
        <div style="flex:1"></div>
        <nav>
          <a class="link" href="/docs" target="_blank">API Docs</a>
          <a class="link" href="#" id="refresh">Refresh</a>
        </nav>
      </div>

      <div class="controls" role="search">
        <input id="q" type="search" placeholder="Search (e.g. fashion, cars, Lagos skyline)" />
        <select id="type">
          <option value="image">Images</option>
          <option value="video">Videos</option>
        </select>
        <select id="category">
          <option value="">All categories</option>
          <option>nature</option><option>fashion</option><option>people</option>
          <option>animals</option><option>travel</option><option>music</option>
          <option>business</option><option>computer</option><option>sports</option>
        </select>
        <select id="orientation">
          <option value="">Any orientation</option>
          <option value="horizontal">Horizontal</option>
          <option value="vertical">Vertical</option>
        </select>
        <label style="display:inline-flex;align-items:center;gap:8px;">
          <input id="safe" type="checkbox" checked /> Safe
        </label>
        <button id="go">Search & Store</button>
      </div>
    </div>
  </header>

  <main>
    <div class="hint">Search stores results in your Gun DB. The grid below loads from <code>/api/feed</code> + live counters from Gun.</div>
    <section id="grid" class="masonry" aria-live="polite"></section>
    <div id="empty" class="empty" hidden>No results yet. Try searching and then hit “Refresh”.</div>
  </main>

  <footer>© 2025 Daniel Effiong — All rights reserved.</footer>

  <script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
  <script>
    const uid = (() => {
      const k = "dme_uid";
      let v = localStorage.getItem(k);
      if (!v) { v = crypto.randomUUID(); localStorage.setItem(k, v); }
      return v;
    })();

    const els = {
      q: document.getElementById("q"),
      type: document.getElementById("type"),
      category: document.getElementById("category"),
      orientation: document.getElementById("orientation"),
      safe: document.getElementById("safe"),
      go: document.getElementById("go"),
      refresh: document.getElementById("refresh"),
      grid: document.getElementById("grid"),
      empty: document.getElementById("empty"),
    };

    const gun = Gun(location.origin.replace(/^http/, 'ws') + "/gun");
    const ROOT = gun.get("dme_pixabay_v1");

    els.go.addEventListener("click", async () => {
      const params = new URLSearchParams({
        query: els.q.value || "nature",
        type: els.type.value,
        category: els.category.value,
        orientation: els.orientation.value,
        safesearch: els.safe.checked ? "true" : "false",
        per_page: els.type.value === "image" ? 24 : 12
      });
      await fetch(`/api/search?${params.toString()}`);
      await loadFeed();
    });

    els.refresh.addEventListener("click", (e) => {
      e.preventDefault();
      loadFeed();
    });

    async function loadFeed() {
      const q = (els.q.value || "nature").toLowerCase();
      const res = await fetch(`/api/feed?query=${encodeURIComponent(q)}&limit=60`);
      const json = await res.json();
      if (!json.ok) return console.error(json.error || "API error");
      render(json.items || []);
    }

    function render(items) {
      els.grid.innerHTML = "";
      if (!items.length) { els.empty.hidden = false; return; }
      els.empty.hidden = true;

      items.forEach(item => {
        const id = String(item.id);
        const card = document.createElement("article");
        card.className = "card";

        let media;
        if (item.type === "image") {
          media = new Image();
          media.src = item.thumb || item.src;
          media.loading = "lazy";
        } else {
          media = document.createElement("video");
          media.src = item.src;
          media.controls = true;
        }
        media.className = "media";
        card.appendChild(media);

        const body = document.createElement("div");
        body.className = "body";

        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div class="title">${item.title || "Untitled"}</div>
          <div><span class="badge" id="lkc-${id}">❤️ 0</span> <span class="badge" id="dwc-${id}">⬇️ 0</span></div>
        `;
        body.appendChild(row);

        const actions = document.createElement("div");
        actions.className = "actions";
        const likeBtn = document.createElement("button");
        likeBtn.className = "chip like";
        likeBtn.innerHTML = `❤️ Like <span class="count" id="lk-${id}"></span>`;
        likeBtn.onclick = () => fetch("/api/like", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ id, uid })
        });
        const dlBtn = document.createElement("button");
        dlBtn.className = "chip";
        dlBtn.innerHTML = `⬇️ Download <span class="count" id="dw-${id}"></span>`;
        dlBtn.onclick = () => fetch("/api/download", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ id })
        });
        actions.append(likeBtn, dlBtn);
        body.appendChild(actions);

        card.appendChild(body);
        els.grid.appendChild(card);

        // live counters from Gun
        const node = ROOT.get("media").get(id);
        node.get("likes").on(v => {
          document.getElementById(`lk-${id}`).textContent = v || 0;
          document.getElementById(`lkc-${id}`).textContent = `❤️ ${v || 0}`;
        });
        node.get("downloads").on(v => {
          document.getElementById(`dw-${id}`).textContent = v || 0;
          document.getElementById(`dwc-${id}`).textContent = `⬇️ ${v || 0}`;
        });
      });
    }

    // Initial load
    els.q.value = "nature";
    loadFeed();
  </script>
</body>
</html>
